# Template to Create AWS CloudFormation Template
The Python Script uses <a href="https://github.com/cloudtools/troposphere">troposphere</a> to create the Template.<br>

I tried creating the script using the AWS Web Tool, but it was quite difficult to get the Template I wanted.

There are some pretty good examples on creating various components on troposphere github. 

The Python Script does some error checking; however, it isn't perfect.  For example, when I created the route for the NAT Gateway I accidentally used GatewayID instead of NatGatewayId and it created the json; however, I got a cryptic error message from Cloudformation.

Right now the script only support a single master and single public agent. At the top you can change num_agents to generate a script for various numbers of agents.

I've only been working with CloudFormation for about a week, so the script will be improved as I learn more.

Steps
- Run Script to Create CloudFormation Template with your desired number of private agents
- Copy your private key and install_dcos.sh to the boot server
- Become root and copy the private key and installer to root's home 
- Run the installer (e.g. bash install_dcos.sh 1 3 1)



# Certificates in AWS

Browsers often block access the Master URL via HTTPS. 

Issue: In Load Balancer I configured a TCP listener for port 443.  In browsers I could see the certificate as the one generated by the Mesosphere. Firefox and IE both rejected and even though you say ignore and proceed you usually cannot access the site.  Chrome would sometimes work after a few tries.  


## Created a certificate

From this [instructions](http://msnider.github.io/blog/2013/12/05/creating-a-self-signed-ssl-certificate-for-an-amazon-elb/)


1. Generate a Private Key The Private Key is used to decrypt messages sent to the server. Keep this safe and secret! Use any password when prompted (we’ll remove it later). **openssl genrsa -des3 -out domain.key 4096**
        
2. Generate a Certificate Signing Request (CSR) The CSR contains the Public Key, used to encrypt messages, and information about the application so the end user (visitor) can see, so enter the information accordingly. **openssl req -nodes -newkey rsa:2048 -keyout domain.key -out domain.csr**
    
    
3. Remove the Password from the Private Key 
- **cp domain.key domain.key.password**
- **openssl rsa -in domain.key.password -out domain.key**

4. Generate the Certificate Make sure to set the number of days before expiration, set to 1 year below. **openssl x509 -req -days 365 -in domain.csr -signkey domain.key -out domain.crt**


5. Open the AWS Console to upload your certificate
- Goto ACM Page
- Click Import Certificate
- Output the certificate to the command line **openssl x509 -inform PEM -in domain.crt**
- Copy everything from the “Begin” to the “End” tags (inclusive)
- Output the private key to the command line **openssl rsa -in domain.key -text**
- Copy everything from the “---BEGIN RSA PRIVATE KEY ----” to the “End” tags (inclusive)
- Click Review and Import
- Click Import


6. Configure Load Balancer
- Select Load Balancer 
- Under Actions Edit Listeners 
- Certificate Type: Click Choose existing certificate from ACM
- Select the Certicate.  **NOTE: I had to refresh my Browser to get the certificate to show up in list**
- Click OK

After making this configuration change I could access from any browser after accepting the normal warnings about invalid certificate (associated with using a self-signed certificate).



